# Invoked via: /init-brain

description = "Comprehensive Brain.php initialization - scans project, analyzes docs/code, generates optimized configuration"
prompt = """
<command>
<meta>
<id>init-brain</id>
<description>Comprehensive Brain.php initialization - scans project, analyzes docs/code, generates optimized configuration</description>
</meta>
<purpose>Discovers project context, analyzes docs/code, researches best practices, generates optimized .brain/node/Brain.php with project-specific guidelines, stores insights to vector memory</purpose>
<purpose>The InitBrain command automates smart distribution of project-specific configuration across Brain.php, Common.php, and Master.php based on project context discovery.</purpose>
<iron_rules>
<rule id="temporal-context-first" severity="critical">
<text>Temporal context MUST be initialized first: Bash('date +"%Y-%m-%d %H:%M:%S %Z"')</text>
<why>Ensures all research and recommendations reflect current year best practices</why>
<on_violation>Missing temporal context leads to outdated recommendations</on_violation>
</rule>
<rule id="parallel-research" severity="critical">
<text>Execute independent research tasks in parallel for efficiency</text>
<why>Maximizes throughput and minimizes total execution time</why>
<on_violation>Sequential execution wastes time on independent tasks</on_violation>
</rule>
<rule id="evidence-based" severity="critical">
<text>All Brain.php guidelines must be backed by discovered project evidence</text>
<why>Prevents generic configurations that do not match project reality</why>
<on_violation>Speculation leads to misaligned Brain behavior</on_violation>
</rule>
<rule id="vector-memory-storage" severity="high">
<text>Store all significant insights to vector memory with semantic tags</text>
<why>Enables future context retrieval and knowledge accumulation</why>
<on_violation>Knowledge loss and inability to leverage past discoveries</on_violation>
</rule>
<rule id="preserve-variation" severity="critical">
<text>NEVER modify or replace existing #[Includes()] attributes on Brain.php Brain already has a Variation (e.g., Scrutinizer) - preserve it Standard includes from vendor/jarvis-brain/core/src/Includes are OFF LIMITS</text>
<why>Variations are pre-configured brain personalities with carefully tuned includes</why>
<on_violation>Modifying Variation breaks brain coherence and predefined behavior</on_violation>
</rule>
<rule id="project-includes-only" severity="critical">
<text>Only analyze and suggest includes from .brain/node/Includes/ FORBIDDEN: vendor/jarvis-brain/core/src/Includes/* modifications FORBIDDEN: Replacing or adding standard includes to Brain.php</text>
<why>Standard includes are managed by Variations, not by init process</why>
<on_violation>Standard includes are bundled with Variation - do not duplicate or override</on_violation>
</rule>
<rule id="smart-distribution" severity="critical">
<text>Distribute project-specific rules across THREE files to avoid duplication: .brain/node/Common.php - Shared by Brain AND all Agents .brain/node/Master.php - Shared by ALL Agents only (NOT Brain) .brain/node/Brain.php - Brain-specific only</text>
<why>Prevents duplication across components, ensures single source of truth for each rule type</why>
<on_violation>Rule placed in wrong file causes duplication or missing context</on_violation>
</rule>
<rule id="distribution-categories" severity="critical">
<text>COMMON: Environment (Docker, CI/CD), project tech stack, universal coding standards, shared config MASTER: Agent execution patterns, tool usage constraints, agent-specific guidelines, task handling BRAIN: Orchestration rules, delegation strategies, Brain-specific policies, workflow coordination</text>
<why>Clear categorization ensures each file serves its specific purpose without overlap</why>
<on_violation>Miscategorized rule leads to missing context or unnecessary duplication</on_violation>
</rule>
<rule id="incremental-enhancement" severity="critical">
<text>ALWAYS analyze existing file content BEFORE enhancement If file has rules/guidelines - PRESERVE valuable existing, ADD only missing NEVER blindly overwrite populated files - merge intelligently Compare discovered patterns with existing config to find gaps</text>
<why>Preserves manual customizations and avoids losing valuable existing configuration</why>
<on_violation>Valuable existing configuration lost, manual work discarded</on_violation>
</rule>
<rule id="extract-to-env-variables" severity="critical">
<text>ALL configurable values in generated code MUST use $this->var("KEY", default) WORKFLOW per file generation (6a, 6b, 7):   1. READ existing .brain/.env to get current variables   2. GENERATE code using $this->var("KEY", default) for configurable values   3. APPEND new variables to .env with # description and # variants: comments Variable candidates: thresholds, limits, toggles, versions, paths, model names Each variable: UPPER_SNAKE_CASE, sensible default, description, variants if applicable NEVER create empty/dummy variables - only those ACTUALLY USED in generated code</text>
<why>Centralizes configuration, enables tuning without code changes, prevents magic values</why>
<on_violation>Hardcoded values in code OR unused variables in .env</on_violation>
</rule>
</iron_rules>
<guidelines>
<guideline id="phase1-temporal-context">
GOAL(Initialize temporal awareness for all subsequent operations)
## Examples
 - Bash(date +"%Y-%m-%d") → [STORE-AS($CURRENT_DATE)] → END-Bash
 - Bash(date +"%Y") → [STORE-AS($CURRENT_YEAR)] → END-Bash
 - Bash(date +"%Y-%m-%d %H:%M:%S %Z") → [STORE-AS($TIMESTAMP)] → END-Bash
 - 
VERIFY-SUCCESS(All temporal variables set)
NOTE(This ensures all research queries include current year for up-to-date results)
</guideline>
<guideline id="phase2-project-discovery">
GOAL(Discover project structure, technology stack, and patterns)
## Examples
 - NOTE(Execute all discovery tasks in parallel for efficiency)
 - **parallel-discovery-tasks**: TASK → [(Task(mcp__brain__agent(explore), 'TASK → [(Check if .docs/ directory exists using Glob + Use Glob("**/.docs/**/*.md") to find documentation files + IF(.docs/ exists) → THEN → [Read all .md files from .docs/ directory → Extract: project goals, requirements, architecture decisions, domain terminology → STORE-AS($DOCS_CONTENT)] → ELSE → [No .docs/ found → STORE-AS($DOCS_CONTENT = \\'null\\')] → END-IF)] → END-TASK', 'CONTEXT(Documentation discovery for project context)') + Task(mcp__brain__agent(explore), 'TASK → [(Analyze project root structure + Use Glob to find: composer.json, package.json, .env.example, README.md + Read key dependency files + Identify project type (Laravel, Node.js, hybrid, etc.) + Extract technology stack from dependency files + STORE-AS($PROJECT_TYPE) + STORE-AS($TECH_STACK = \\'{languages: [...], frameworks: [...], packages: [...], services: [...]}\\'))] → END-TASK', 'CONTEXT(Codebase structure and tech stack analysis)') + Task(mcp__brain__agent(explore), 'TASK → [(Scan for architectural patterns + Use Glob to find PHP/JS/TS files in app/ and src/ directories + Analyze code structure and organization + Identify: MVC, DDD, CQRS, microservices, monolith, etc. + Detect design patterns: repositories, services, factories, observers, etc. + Find coding conventions: naming, structure, organization + STORE-AS($ARCHITECTURE_PATTERNS = \\'{architecture_style: "...", design_patterns: [...], conventions: [...]}\\'))] → END-TASK', 'CONTEXT(Architecture pattern discovery)') + Task(mcp__brain__agent(explore), 'TASK → [(Read(\\'.brain/node/Brain.php\\') + Read(\\'.brain/node/Common.php\\') + Read(\\'.brain/node/Master.php\\') + For EACH file analyze handle() method content: +   - Extract existing $this->rule() definitions (id, severity, text) +   - Extract existing $this->guideline() definitions (id, phases, examples) +   - Identify custom logic and project-specific patterns +   - Mark as POPULATED if handle() has meaningful content beyond skeleton + STORE-AS($CURRENT_BRAIN_CONFIG = \\'{includes: [...], rules: [...], guidelines: [...], is_populated: bool}\\') + STORE-AS($CURRENT_COMMON_CONFIG = \\'{rules: [...], guidelines: [...], is_populated: bool}\\') + STORE-AS($CURRENT_MASTER_CONFIG = \\'{rules: [...], guidelines: [...], is_populated: bool}\\'))] → END-TASK', 'CONTEXT(Existing configuration analysis for incremental enhancement)'))] → END-TASK
 - VERIFY-SUCCESS(All discovery tasks completed)
 - STORE-AS($PROJECT_CONTEXT = 'Merged results from all discovery tasks')
</guideline>
<guideline id="phase2-5-environment-discovery">
GOAL(Discover environment configuration, containerization, and infrastructure patterns)
## Examples
 - NOTE(Environment rules go to Common.php - shared by Brain AND all Agents)
 - **parallel-environment-tasks**: TASK → [(Task(mcp__brain__agent(explore), 'TASK → [(Use Glob to find: Dockerfile*, docker-compose*.yml, .dockerignore + Read Docker configurations if found + Extract: base images, services, ports, volumes, networks + Identify: container orchestration patterns (Docker Compose, K8s, etc.) + STORE-AS($DOCKER_CONFIG = \\'{has_docker: bool, services: [...], patterns: [...]}\\'))] → END-TASK', 'CONTEXT(Docker and containerization discovery)') + Task(mcp__brain__agent(explore), 'TASK → [(Use Glob to find: .github/workflows/*.yml, .gitlab-ci.yml, Jenkinsfile, bitbucket-pipelines.yml + Read CI/CD configurations if found + Extract: build steps, test runners, deployment targets + Identify: CI/CD platform and workflow patterns + STORE-AS($CICD_CONFIG = \\'{platform: "...", workflows: [...], deployment_targets: [...]}\\'))] → END-TASK', 'CONTEXT(CI/CD pipeline discovery)') + Task(mcp__brain__agent(explore), 'TASK → [(Use Glob to find: .editorconfig, .prettierrc*, .eslintrc*, phpcs.xml*, phpstan.neon* + Read linter/formatter configurations if found + Extract: code style rules, linting rules, analysis levels + Identify: tooling ecosystem (Prettier, ESLint, PHPStan, etc.) + STORE-AS($DEV_TOOLS_CONFIG = \\'{formatters: [...], linters: [...], analyzers: [...]}\\'))] → END-TASK', 'CONTEXT(Development tooling discovery)') + Task(mcp__brain__agent(explore), 'TASK → [(Use Glob to find: .env.example, config/*.php, infrastructure/* + Analyze service connections: databases, caches, queues, storage + Identify: external service dependencies (AWS, GCP, Redis, Elasticsearch) + Map infrastructure topology + STORE-AS($INFRASTRUCTURE_CONFIG = \\'{services: [...], external_deps: [...], topology: {...}}\\'))] → END-TASK', 'CONTEXT(Infrastructure and services discovery)'))] → END-TASK
 - VERIFY-SUCCESS(Environment discovery completed)
 - STORE-AS($ENVIRONMENT_CONTEXT = 'Merged environment configuration')
</guideline>
<guideline id="phase3-documentation-analysis">
GOAL(Deep analysis of project documentation to extract requirements and domain knowledge)
## Examples
 - IF(STORE-GET($DOCS_CONTENT) !== null) → THEN → [Task(mcp__brain__agent(documentation-master), 'INPUT(STORE-GET($DOCS_CONTENT))', 'TASK → [(Analyze all documentation files + Extract: project goals, requirements, constraints, domain concepts + Identify: key workflows, business rules, integration points + Map documentation to Brain configuration needs + Suggest: custom includes, rules, guidelines based on docs)] → END-TASK', 'OUTPUT({goals: [...], requirements: [...], domain_concepts: [...], suggested_config: {...}})') → STORE-AS($DOCS_ANALYSIS)] → ELSE → [No documentation found - will rely on codebase analysis only → STORE-AS($DOCS_ANALYSIS = 'null')] → END-IF
</guideline>
<guideline id="phase3-5-vector-memory-research">

GOAL(Deep research of vector memory via specialized VectorMaster agents for each target file)
NOTE(Vector memory may be LARGE - simple search is insufficient Each file needs DEEP recursive semantic research by dedicated agent VectorMaster performs multi-probe strategy: DECOMPOSE → MULTI-SEARCH → ANALYZE Focus: knowledge that CANNOT be found via codebase exploration)

## Examples
 - **parallel-vector-research-agents**: TASK → [(Task(mcp__brain__agent(vector-master), 'CONTEXT(Target file: .brain/node/Common.php This file is shared by Brain AND all Agents)', 'TASK → [(DEEP RESEARCH vector memory for Common.php guidelines +  + Search domains (multi-probe each): +   - Environment constraints: Docker, CI/CD, containerization rules +   - Tech stack: PHP version, Node version, database conventions +   - Universal coding standards: naming, structure, organization +   - Shared configuration: env vars, paths, external services +   - Development tooling: linters, formatters, analyzers +   - Infrastructure patterns: services, networking, deployment +  + For EACH domain: +   1. Decompose into 2-3 semantic probes +   2. Execute searches with different query angles +   3. Cross-reference findings +   4. Extract ACTIONABLE insights only +  + FILTER criteria: +   - Must apply to BOTH Brain AND Agents (universal) +   - Cannot be discovered via normal codebase search +   - Represents hard-won knowledge or critical constraints +  + OUTPUT: Detailed recommendations for Common.php rules/guidelines)] → END-TASK', 'OUTPUT({recommendations: [...], insights_found: N, domains_covered: [...], confidence: high|medium|low})') + STORE-AS($VECTOR_COMMON_RESEARCH) + Task(mcp__brain__agent(vector-master), 'CONTEXT(Target file: .brain/node/Master.php This file is shared by ALL Agents only (NOT Brain))', 'TASK → [(DEEP RESEARCH vector memory for Master.php guidelines +  + Search domains (multi-probe each): +   - Agent execution patterns: how agents should approach tasks +   - Tool usage constraints: when to use which tools, anti-patterns +   - Task handling: decomposition, estimation, status flow +   - Code generation patterns: templates, scaffolding, conventions +   - Test writing conventions: test structure, coverage, mocking +   - Quality gates: validation before completion, review criteria +  + For EACH domain: +   1. Decompose into 2-3 semantic probes +   2. Execute searches with different query angles +   3. Cross-reference findings +   4. Extract ACTIONABLE insights only +  + FILTER criteria: +   - Must apply to Agents execution (not Brain orchestration) +   - Cannot be discovered via normal codebase search +   - Represents patterns that prevent repeated mistakes +  + OUTPUT: Detailed recommendations for Master.php rules/guidelines)] → END-TASK', 'OUTPUT({recommendations: [...], insights_found: N, domains_covered: [...], confidence: high|medium|low})') + STORE-AS($VECTOR_MASTER_RESEARCH) + Task(mcp__brain__agent(vector-master), 'CONTEXT(Target file: .brain/node/Brain.php This file is Brain-specific only (orchestration layer))', 'TASK → [(DEEP RESEARCH vector memory for Brain.php guidelines +  + Search domains (multi-probe each): +   - Orchestration rules: delegation strategies, agent selection +   - Brain policies: approval chains, escalation patterns +   - Workflow coordination: multi-agent orchestration, sequencing +   - Response synthesis: how to merge agent results, validation +   - Brain-level validation: quality gates, trust management +   - Context management: memory limits, compaction triggers +  + For EACH domain: +   1. Decompose into 2-3 semantic probes +   2. Execute searches with different query angles +   3. Cross-reference findings +   4. Extract ACTIONABLE insights only +  + FILTER criteria: +   - Must apply to Brain orchestration (not agent execution) +   - Cannot be discovered via normal codebase search +   - Represents critical coordination knowledge +  + OUTPUT: Detailed recommendations for Brain.php rules/guidelines)] → END-TASK', 'OUTPUT({recommendations: [...], insights_found: N, domains_covered: [...], confidence: high|medium|low})') + STORE-AS($VECTOR_BRAIN_RESEARCH))] → END-TASK
 - Merge and validate all VectorMaster research results
 - Task(mcp__brain__agent(agent-master), 'INPUT(STORE-GET($VECTOR_COMMON_RESEARCH) && STORE-GET($VECTOR_MASTER_RESEARCH) && STORE-GET($VECTOR_BRAIN_RESEARCH))', 'TASK → [(VALIDATE and CONSOLIDATE VectorMaster research results +  + For EACH file research result: +   1. Verify recommendations are correctly categorized (Common/Master/Brain) +   2. Check for cross-file duplicates - keep in most appropriate file +   3. Validate insights are truly unique (not in standard includes) +   4. Assess confidence level of each recommendation +  + QUALITY GATES: +   - Reject low-confidence insights without strong evidence +   - Reject generic insights that apply everywhere (noise) +   - Reject outdated or superseded knowledge +  + OUTPUT: Validated insights ready for Phase 6 distribution)] → END-TASK', 'OUTPUT({critical_common: [...], critical_master: [...], critical_brain: [...], total_found: N, total_validated: N, rejected: N, rejection_reasons: [...]})')
 - STORE-AS($VECTOR_CRITICAL_INSIGHTS)
 - NOTE(Validated vector insights will be merged into DISTRIBUTED_GUIDELINES in Phase 6)
</guideline>
<guideline id="phase4-project-includes">

GOAL(Analyze and suggest PROJECT-SPECIFIC includes only (NOT standard includes))
NOTE(IMPORTANT: Brain already has a Variation with standard includes configured This phase focuses ONLY on .brain/node/Includes/ FORBIDDEN: Suggesting or modifying vendor/jarvis-brain/core/src/Includes/*)

## Examples
 - Task(mcp__brain__agent(explore), 'TASK → [(Scan .brain/node/Includes/ for existing project includes + Read each include file to understand its purpose + Identify gaps in project-specific configuration)] → END-TASK', 'CONTEXT(Project-specific includes discovery)')
 - STORE-AS($EXISTING_PROJECT_INCLUDES)
 - Task(mcp__brain__agent(agent-master), 'INPUT(STORE-GET($EXISTING_PROJECT_INCLUDES) && STORE-GET($PROJECT_CONTEXT) && STORE-GET($DOCS_ANALYSIS))', 'TASK → [(Analyze existing project-specific includes in .brain/node/Includes/ + Map project needs to include capabilities + Identify MISSING project-specific includes that should be CREATED + DO NOT suggest standard includes from vendor/jarvis-brain/core/src/Includes + Generate list of new project includes to create via brain make:include)] → END-TASK', 'OUTPUT({existing_project_includes: [...], suggested_new_includes: [...], rationale: {...}})')
 - STORE-AS($PROJECT_INCLUDES_RECOMMENDATION)
</guideline>
<guideline id="phase5-smart-distribution">

GOAL(Categorize discovered rules/guidelines into Common, Master, or Brain files)
NOTE(CRITICAL: Each rule MUST go to exactly ONE file to avoid duplication .brain/node/Common.php - Shared by Brain AND all Agents .brain/node/Master.php - Shared by ALL Agents only .brain/node/Brain.php - Brain-specific only)

## Examples
 - Task(mcp__brain__agent(agent-master), 'INPUT(STORE-GET($PROJECT_CONTEXT) && STORE-GET($ENVIRONMENT_CONTEXT) && STORE-GET($DOCS_ANALYSIS) && STORE-GET($ARCHITECTURE_PATTERNS) && STORE-GET($VECTOR_CRITICAL_INSIGHTS))', 'TASK → [(Analyze ALL discovered project patterns, rules, AND critical vector insights + MERGE VECTOR_CRITICAL_INSIGHTS into distribution (already categorized) + CATEGORIZE remaining rules into exactly ONE target file: +  + COMMON.PHP (Brain + ALL Agents): +   - Docker/container environment rules (ports, services, networks) +   - CI/CD pipeline awareness (test commands, build steps) +   - Project tech stack rules (PHP version, Node version, database type) +   - Universal coding standards (naming conventions, file structure) +   - Shared configuration (env vars, paths, external services) +   - Development tooling rules (linters, formatters, analyzers) +  + MASTER.PHP (ALL Agents only, NOT Brain): +   - Agent execution patterns (how agents should approach tasks) +   - Tool usage constraints (when to use which tools) +   - Task handling guidelines (decomposition, estimation, status flow) +   - Code generation patterns (templates, scaffolding) +   - Test writing conventions (test structure, coverage expectations) +   - Agent-specific quality gates (validation before completion) +  + BRAIN.PHP (Brain-specific only): +   - Orchestration rules (delegation strategies, agent selection) +   - Brain-specific policies (approval chains, escalation) +   - Workflow coordination (multi-agent orchestration) +   - Response synthesis (how to merge agent results) +   - Brain-level validation (response quality gates) +  + Generate PHP Builder API code for each category + Use $this->rule() for constraints, $this->guideline() for patterns)] → END-TASK', 'OUTPUT({common: [{id, type, code}], master: [{id, type, code}], brain: [{id, type, code}], rationale: {...}})')
 - STORE-AS($DISTRIBUTED_GUIDELINES)
</guideline>
<guideline id="phase5a-common-enhancement">

GOAL(Enhance Common.php with shared project rules for Brain AND all Agents)
NOTE(Common.php is included by BOTH BrainIncludesTrait AND AgentIncludesTrait Rules here apply universally - avoid agent-specific or brain-specific content Focus: environment, tech stack, coding standards, shared configuration)

## Examples
 - Read existing Common.php and .env
 - TASK → [(Read('.brain/node/Common.php') + IF(.brain/.env exists) → THEN → [Read('.brain/.env') → STORE-AS($EXISTING_ENV)] → ELSE → [STORE-AS($EXISTING_ENV = '')] → END-IF)] → END-TASK
 - STORE-AS($CURRENT_COMMON_CONFIG)
 - Task(mcp__brain__agent(prompt-master), 'INPUT(STORE-GET($CURRENT_COMMON_CONFIG) && STORE-GET($DISTRIBUTED_GUIDELINES.common) && STORE-GET($ENVIRONMENT_CONTEXT))', 'TASK → [(PRESERVE existing class structure, namespace, and extends IncludeArchetype + IF(CURRENT_COMMON_CONFIG.is_populated) → THEN → [MERGE MODE: File has existing content →   - KEEP all existing rules/guidelines that are still relevant →   - UPDATE rules if new discovery provides better info (same id, improved text) →   - ADD only NEW rules/guidelines not already present →   - REMOVE nothing unless explicitly obsolete →   - Compare rule IDs to avoid duplicates] → ELSE → [FRESH MODE: File is empty/skeleton - add all discovered rules] → END-IF + Focus on environment and universal rules: +   - Docker/container configuration awareness +   - Tech stack version constraints +   - Universal coding conventions +   - Shared infrastructure knowledge +  + CRITICAL - GENERATE CODE WITH $this->var() IMMEDIATELY: +   WRONG: ->text("PHP version must be 8.3") +   RIGHT: ->text(["PHP version must be", $this->var("PHP_VERSION", "8.3")]) +   WRONG: $limit = 100; +   RIGHT: $limit = $this->var("MAX_LINE_LENGTH", 100); +  +   For EACH configurable value in generated code: +     1. USE $this->var("KEY", default) IN THE CODE IMMEDIATELY +     2. COLLECT to env_vars: {name: "KEY", default: "value", description: "...", variants: "..."} +  +   Candidates: PHP_VERSION, NODE_VERSION, DATABASE_TYPE, DOCKER_ENABLED +   Candidates: PHPSTAN_LEVEL, TEST_COVERAGE_MIN, MAX_LINE_LENGTH +  + Apply prompt engineering: clarity, brevity, token efficiency)] → END-TASK', 'OUTPUT({common_php_content: "...", rules_kept: [...], rules_added: [...], rules_updated: [...], env_vars: [{name, default, description, variants}]})')
 - Brain receives PromptMaster response with content + env_vars
 - STORE-AS($ENHANCED_COMMON_PHP)
 - TASK → [(Write .brain/node/Common.php from ENHANCED_COMMON_PHP.common_php_content + IF(ENHANCED_COMMON_PHP.env_vars not empty) → THEN → [APPEND to .brain/.env: →   # ═══ COMMON ═══ (if not already present) →   For EACH env_var in ENHANCED_COMMON_PHP.env_vars: →     IF var.name NOT in EXISTING_ENV: →       # {var.description} →       # variants: {var.variants} →       {var.name}={var.default}] → END-IF)] → END-TASK
 - NOTE(Common.php written + new env vars appended to .env)
</guideline>
<guideline id="phase5b-master-enhancement">

GOAL(Enhance Master.php with agent-specific rules shared by ALL Agents)
NOTE(Master.php is included by AgentIncludesTrait only (NOT Brain) Rules here apply to all agents but NOT to Brain orchestration Focus: execution patterns, tool usage, task handling, code generation)

## Examples
 - Read existing Master.php
 - Read('.brain/node/Master.php')
 - STORE-AS($CURRENT_MASTER_CONFIG)
 - Task(mcp__brain__agent(prompt-master), 'INPUT(STORE-GET($CURRENT_MASTER_CONFIG) && STORE-GET($DISTRIBUTED_GUIDELINES.master) && STORE-GET($ARCHITECTURE_PATTERNS))', 'TASK → [(PRESERVE existing class structure, namespace, and extends IncludeArchetype + IF(CURRENT_MASTER_CONFIG.is_populated) → THEN → [MERGE MODE: File has existing content →   - KEEP all existing rules/guidelines that are still relevant →   - UPDATE rules if new discovery provides better info (same id, improved text) →   - ADD only NEW rules/guidelines not already present →   - REMOVE nothing unless explicitly obsolete →   - Compare rule IDs to avoid duplicates] → ELSE → [FRESH MODE: File is empty/skeleton - add all discovered rules] → END-IF + Focus on agent execution patterns: +   - How agents should approach project tasks +   - Tool usage patterns for this project +   - Code generation conventions +   - Test writing patterns +   - Quality gates before task completion +  + CRITICAL - GENERATE CODE WITH $this->var() IMMEDIATELY: +   WRONG: ->text("Max task estimate is 8 hours") +   RIGHT: ->text(["Max task estimate is", $this->var("MAX_TASK_ESTIMATE_HOURS", 8), "hours"]) +   WRONG: $model = "sonnet"; +   RIGHT: $model = $this->var("DEFAULT_AGENT_MODEL", "sonnet"); +  +   For EACH configurable value in generated code: +     1. USE $this->var("KEY", default) IN THE CODE IMMEDIATELY +     2. COLLECT to env_vars: {name: "KEY", default: "value", description: "...", variants: "..."} +  +   Candidates: MAX_TASK_ESTIMATE_HOURS, DEFAULT_AGENT_MODEL, PARALLEL_TASKS +   Candidates: REQUIRE_TESTS, MIN_COVERAGE, CODE_REVIEW_ENABLED +  + Apply prompt engineering: clarity, brevity, token efficiency)] → END-TASK', 'OUTPUT({master_php_content: "...", rules_kept: [...], rules_added: [...], rules_updated: [...], env_vars: [{name, default, description, variants}]})')
 - Brain receives PromptMaster response with content + env_vars
 - STORE-AS($ENHANCED_MASTER_PHP)
 - TASK → [(Write .brain/node/Master.php from ENHANCED_MASTER_PHP.master_php_content + IF(ENHANCED_MASTER_PHP.env_vars not empty) → THEN → [APPEND to .brain/.env: →   # ═══ MASTER ═══ (if not already present) →   For EACH env_var in ENHANCED_MASTER_PHP.env_vars: →     IF var.name NOT in EXISTING_ENV: →       # {var.description} →       # variants: {var.variants} →       {var.name}={var.default}] → END-IF)] → END-TASK
 - NOTE(Master.php written + new env vars appended to .env)
</guideline>
<guideline id="phase6-brain-enhancement">

GOAL(Enhance Brain.php with Brain-specific orchestration rules ONLY)
NOTE(CRITICAL: Preserve ALL existing #[Includes()] attributes - they define the Variation ONLY add Brain-specific rules (orchestration, delegation, synthesis) Common rules go to Common.php, agent rules go to Master.php)

## Examples
 - Enhance handle() method with Brain-specific content only
 - Task(mcp__brain__agent(prompt-master), 'INPUT(STORE-GET($CURRENT_BRAIN_CONFIG) && STORE-GET($PROJECT_INCLUDES_RECOMMENDATION) && STORE-GET($DISTRIBUTED_GUIDELINES.brain) && STORE-GET($PROJECT_CONTEXT))', 'TASK → [(PRESERVE existing #[Includes()] attributes (Variation) - DO NOT MODIFY + PRESERVE existing class structure and namespace + IF(CURRENT_BRAIN_CONFIG.is_populated) → THEN → [MERGE MODE: File has existing handle() content →   - KEEP all existing rules/guidelines in handle() that are still relevant →   - UPDATE rules if new discovery provides better info (same id, improved text) →   - ADD only NEW Brain-specific rules not already present →   - REMOVE nothing unless explicitly obsolete →   - Compare rule IDs to avoid duplicates] → ELSE → [FRESH MODE: handle() is empty/skeleton - add all Brain-specific rules] → END-IF + Focus on Brain-specific rules only (Common/Master rules already distributed): +   - Orchestration and delegation strategies +   - Agent selection criteria for this project +   - Response synthesis patterns +   - Brain-level validation gates +  + CRITICAL - GENERATE CODE WITH $this->var() IMMEDIATELY: +   WRONG: ->text("Default model is sonnet") +   RIGHT: ->text(["Default model is", $this->var("DEFAULT_MODEL", "sonnet")]) +   WRONG: $depth = 2; +   RIGHT: $depth = $this->var("MAX_DELEGATION_DEPTH", 2); +  +   For EACH configurable value in generated code: +     1. USE $this->var("KEY", default) IN THE CODE IMMEDIATELY +     2. COLLECT to env_vars: {name: "KEY", default: "value", description: "...", variants: "..."} +  +   Candidates: DEFAULT_MODEL, MAX_DELEGATION_DEPTH, VALIDATION_THRESHOLD +   Candidates: ENABLE_PARALLEL_AGENTS, MAX_RETRIES, RESPONSE_MAX_TOKENS +  + If suggested new project includes, add to #[Includes()] AFTER existing + Apply prompt engineering: clarity, brevity, token efficiency)] → END-TASK', 'OUTPUT({brain_php_content: "...", preserved_variation: "...", rules_kept: [...], rules_added: [...], rules_updated: [...], env_vars: [{name, default, description, variants}]})')
 - Brain receives PromptMaster response with content + env_vars
 - STORE-AS($ENHANCED_BRAIN_PHP)
 - TASK → [(Write .brain/node/Brain.php from ENHANCED_BRAIN_PHP.brain_php_content + IF(ENHANCED_BRAIN_PHP.env_vars not empty) → THEN → [APPEND to .brain/.env: →   # ═══ BRAIN ═══ (if not already present) →   For EACH env_var in ENHANCED_BRAIN_PHP.env_vars: →     IF var.name NOT in EXISTING_ENV: →       # {var.description} →       # variants: {var.variants} →       {var.name}={var.default}] → END-IF)] → END-TASK
 - NOTE(Brain.php written + new env vars appended to .env)
</guideline>
<guideline id="phase7-compilation">
GOAL(Validate syntax and compile all enhanced files)
## Examples
 - Validate PHP syntax for all modified files
 - TASK → [(Bash(php -l .brain/node/Common.php) → [Validate Common.php syntax] → END-Bash + Bash(php -l .brain/node/Master.php) → [Validate Master.php syntax] → END-Bash + Bash(php -l .brain/node/Brain.php) → [Validate Brain.php syntax] → END-Bash)] → END-TASK
 - IF(any syntax validation failed) → THEN → [Report syntax errors with file:line details → Provide fix suggestions → OUTPUT(Syntax validation failed - review errors above)] → END-IF
 - Compile Brain ecosystem
 - Bash(brain compile) → [Compile .brain/node/Brain.php with includes to GEMINI.md] → END-Bash
 - VERIFY-SUCCESS(Compilation succeeded GEMINI.md exists No compilation errors Common.php included via BrainIncludesTrait Master.php available for AgentIncludesTrait)
 - IF(compilation failed) → THEN → [Report compilation errors with details → Provide fix suggestions → OUTPUT(Compilation failed - review errors above)] → END-IF
</guideline>
<guideline id="phase8-knowledge-storage">
GOAL(Store all insights to vector memory for future reference)
## Examples
 - mcp__vector-memory__store_memory('INPUT(content: "Brain Initialization - Project: {project_type}, Tech Stack: {tech_stack}, Patterns: {architecture_patterns}, Date: {current_date}" && category: "architecture" && tags: ["init-brain", "project-discovery", "configuration"])')
 - mcp__vector-memory__store_memory('INPUT(content: "Environment Discovery - Docker: {has_docker}, CI/CD: {cicd_platform}, Dev Tools: {dev_tools}, Date: {current_date}" && category: "architecture" && tags: ["init-brain", "environment", "infrastructure"])')
 - mcp__vector-memory__store_memory('INPUT(content: "Smart Distribution - Common: {common_rules_count} rules, Master: {master_rules_count} rules, Brain: {brain_rules_count} rules, Date: {current_date}" && category: "architecture" && tags: ["init-brain", "distribution", "configuration"])')
 - mcp__vector-memory__store_memory('INPUT(content: "Vector Memory Mining - Common: {vector_common_count}, Master: {vector_master_count}, Brain: {vector_brain_count}, Total validated: {vector_total_validated}, Date: {current_date}" && category: "learning" && tags: ["init-brain", "vector-mining", "insights"])')
</guideline>
<guideline id="phase9-report">
GOAL(Generate comprehensive initialization report with smart distribution summary)
## Examples
 - OUTPUT(Brain Ecosystem Initialization Complete  ═══════════════════════════════════════════════════════ SMART DISTRIBUTION SUMMARY ═══════════════════════════════════════════════════════  .brain/node/Common.php (Brain + ALL Agents):   Mode: {common_mode}   Kept: {common_rules_kept} | Added: {common_rules_added} | Updated: {common_rules_updated}   ENV vars: {common_env_count}  .brain/node/Master.php (ALL Agents only):   Mode: {master_mode}   Kept: {master_rules_kept} | Added: {master_rules_added} | Updated: {master_rules_updated}   ENV vars: {master_env_count}  .brain/node/Brain.php (Brain only):   Variation: {existing_variation_name} (PRESERVED)   Mode: {brain_mode}   Kept: {brain_rules_kept} | Added: {brain_rules_added} | Updated: {brain_rules_updated}   ENV vars: {brain_env_count}  ═══════════════════════════════════════════════════════ DISCOVERY RESULTS ═══════════════════════════════════════════════════════  Project:   Type: {project_type}   Tech Stack: {tech_stack}   Architecture: {architecture_patterns}  Environment:   Docker: {has_docker}   CI/CD Platform: {cicd_platform}   Dev Tools: {dev_tools}   Infrastructure: {infrastructure_services}  Documentation:   Files Analyzed: {docs_file_count}   Domain Concepts: {domain_concepts_count}   Requirements: {requirements_count}  Vector Memory Mining:   Total Mined: {vector_total_mined}   Critical Filtered: {vector_critical_count}   Added to Common: {vector_common_count}   Added to Master: {vector_master_count}   Added to Brain: {vector_brain_count}  ═══════════════════════════════════════════════════════ OUTPUT FILES ═══════════════════════════════════════════════════════  Source Files:   .brain/node/Brain.php   .brain/node/Common.php   .brain/node/Master.php  Compiled Output:   GEMINI.md  Configuration:   .brain/.env   Variables: {env_settings_count} ({env_kept} kept, {env_added} added)  ═══════════════════════════════════════════════════════ VECTOR MEMORY ═══════════════════════════════════════════════════════    Insights Stored: {insights_count}   Categories: architecture, learning   Tags: init-brain, project-discovery, distribution  ═══════════════════════════════════════════════════════ NEXT STEPS ═══════════════════════════════════════════════════════    1. Review enhanced files:      - Common.php: shared environment/coding rules      - Master.php: agent execution patterns      - Brain.php: orchestration rules (Variation preserved)    2. If project includes suggested:      brain make:include {name}    3. Test Brain behavior with sample tasks    4. After any modifications:      brain compile    5. Consider running:      /init-agents for agent generation      /init-vector for vector memory population)
</guideline>
<guideline id="error-recovery">
Comprehensive error handling for all failure scenarios
## Examples
 - IF(no .docs/ found) → THEN → [Continue with codebase analysis only → Log: Documentation not available] → END-IF
 - IF(tech stack detection fails) → THEN → [Use manual fallback detection → Analyze file extensions and structure] → END-IF
 - IF(vector memory research fails) → THEN → [Continue with codebase-only discovery → Log: Vector memory unavailable] → END-IF
 - IF(brain list:includes fails) → THEN → [Use hardcoded standard includes list → Log: Include discovery failed] → END-IF
 - IF(Brain.php generation fails) → THEN → [Report detailed error with file:line → Provide manual fix guidance] → END-IF
 - IF(brain compile fails) → THEN → [Analyze compilation errors → Provide fix suggestions] → END-IF
 - IF(vector memory storage fails) → THEN → [Continue without storage → Log: Memory storage unavailable] → END-IF
</guideline>
<guideline id="quality-gates">
Validation checkpoints throughout initialization
## Examples
 - Gate 1: Temporal context initialized (date, year, timestamp)
 - Gate 2: Project discovery completed with valid tech stack
 - Gate 3: Environment discovery completed (Docker, CI/CD, Dev Tools)
 - Gate 4: At least one discovery task succeeded (docs OR codebase)
 - Gate 5: Smart distribution categorization completed (Common/Master/Brain)
 - Gate 6: All enhanced files written successfully
 - Gate 7: All enhanced files pass PHP syntax validation
 - Gate 8: Compilation completes without errors
 - Gate 9: Compiled output exists at GEMINI.md
 - Gate 10: At least one insight stored to vector memory
</guideline>
<guideline id="example-laravel-docker-project">
SCENARIO(Laravel project with Docker, Sail, and comprehensive documentation)
## Examples
 - Discovery: Laravel 11, PHP 8.3, MySQL, Redis, Queue, Sanctum
 - Environment: Docker (Sail), GitHub Actions CI/CD, PHPStan L8
 - Docs: 15 .md files with architecture, requirements, domain logic
 - Vector Mining: 12 insights found, 8 validated for distribution
 - SMART DISTRIBUTION:
 -   Common.php: Docker/Sail environment rules, PHP 8.3 type constraints, MySQL conventions
 -   Master.php: Service class patterns, repository usage, Pest test conventions
 -   Brain.php: Agent delegation for Laravel domains (Auth, Queue, Cache)
 - Result: All three files enhanced, Scrutinizer Variation preserved
 - Insights: 8 architectural insights stored to vector memory
</guideline>
<guideline id="example-node-docker-project">
SCENARIO(Node.js/Express project with Docker and TypeScript)
## Examples
 - Discovery: Node.js 20, Express, TypeScript, MongoDB
 - Environment: Docker Compose, GitLab CI, ESLint + Prettier
 - Docs: None found - codebase analysis only
 - Vector Mining: 7 insights found, 5 validated for distribution
 - SMART DISTRIBUTION:
 -   Common.php: Docker network rules, Node 20 constraints, ESLint compliance
 -   Master.php: TypeScript type generation, async/await patterns, Jest test structure
 -   Brain.php: API route delegation strategy
 - Result: All three files enhanced, Architect Variation preserved
 - Insights: 5 tech stack insights stored
</guideline>
<guideline id="example-hybrid-microservices">
SCENARIO(Hybrid PHP/JavaScript microservices with Kubernetes)
## Examples
 - Discovery: Laravel API + React SPA + Docker + Kafka
 - Environment: Kubernetes, GitHub Actions, PHPStan + ESLint
 - Docs: ADRs, API specs, deployment docs, domain model
 - Vector Mining: 18 insights found, 12 validated for distribution
 - SMART DISTRIBUTION:
 -   Common.php: K8s service discovery, cross-service authentication, Kafka topic naming
 -   Master.php: Event schema validation, API contract testing, service boundary respect
 -   Brain.php: Multi-service orchestration, cross-domain delegation, event saga coordination
 - Project Includes: Suggested MicroserviceBoundaries.php, EventSchemas.php
 - Result: All three files enhanced with microservice awareness
 - Insights: 12 cross-cutting concerns stored
</guideline>
<guideline id="performance-optimization">
Optimization strategies for efficient initialization
## Examples
 - Parallel Execution: All independent tasks run simultaneously
 - Selective Reading: Only read files needed for analysis
 - Incremental Storage: Store insights progressively, not at end
 - Smart Caching: Leverage vector memory for repeated runs
 - Early Validation: Fail fast on critical errors
 - Streaming Output: Report progress as phases complete
</guideline>
<guideline id="directive">
Core initialization directive
## Examples
 - Discover thoroughly! Research current practices! Configure precisely! Validate rigorously! Store knowledge! Report comprehensively!
</guideline>
</guidelines>
</command>
"""